'use strict';

module.exports = ({ morgan, config, logger }) => {
  const {
    LOGGED_OUT_SLUG,
    TOKENS: { USER_SLUG },
  } = config.SERVER.MORGAN_OPTIONS;

  function getUserSlug(req) {
    return req.user && req.user.slug ? req.user.slug : LOGGED_OUT_SLUG;
  }

  function buildCustomFormat(tokens, req, res) {
    return [
      tokens.method(req, res),
      tokens.url(req, res),
      tokens.status(req, res),
      tokens[USER_SLUG](req),
      tokens['response-time'](req, res),
      'ms',
    ].join(' ');
  }

  function buildMiddleware(labels) {
    // Setup Morgan with custom format and Apolitical Logger stream
    morgan.token(USER_SLUG, getUserSlug);
    const morganMiddleware = morgan(buildCustomFormat, logger.where(__filename, 'morganMiddleware', labels));
    return morganMiddleware;
  }

  return { getUserSlug, buildMiddleware };
};
