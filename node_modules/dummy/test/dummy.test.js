var net = require('net');
var colors = require('colors');
var should = require('should');

var Dummy = require('../lib/dummy');

var server;
var serverPort = 11110;

describe('dummy', function() {
    before(function(_done) {
        server = net.createServer(function(_socket) {
            var dataBuffer = '';
            _socket.on('data', function(_data) {
        		dataBuffer += _data.toString();
        		//split the dataBuffer on the newline character, this is because
        		//  multiple messages may have fit into one packet
        		var subdata = dataBuffer.split('\n');
        		for(var i = 0; i < subdata.length - 1; i++)	{
        		    var data = subdata[i];
        		    try {
        		        data = JSON.parse(subdata[i]);
        		    } catch (_error) {}
        		    if(typeof data === 'object') {
        		        handleObject(data);
        		    } else{
        		        handlePlain(data);
        		    }
        		}
        		//if the last message in the array did not have a newline at the end
        		//  set that equal to the buffer, as the end of the message should be
        		//  contained in the next packet
        		dataBuffer = subdata[subdata.length - 1];
            });
            
            //handle the data by prepending it with 'you sent : ', righto
            var handlePlain = function(_data) {
                var responseData = "you sent : " + _data.toString();
                _socket.write(responseData);
            }
            var handleObject = function(_obj) {
                var responseObject = {
                    object: _obj
                }
                _socket.write(JSON.stringify(responseObject) + '\n');
            }
        });
        server.listen(serverPort, function() {
           _done(); 
        });
    });
    after(function(_done) {
        server.close();
        _done();
    });
    describe('#Dummy()', function() {
        it('should return a new dummy client, and connect to a server', function(_done) {
            var dummy = new Dummy(false, serverPort, '127.0.0.1', '\n', function() {
                should.exist(dummy);
                _done();
            });
        });
    });
    describe('#send()', function() {
        //the following two tests are mostly self explanatory
        it('should get a callback when the data responded was equal to what was respected', function(_done) {
            var dummy = new Dummy(false, serverPort, '127.0.0.1', '\n', function() {
                dummy.send('hey', 'you sent : hey', function(_expected, _data) {
                    _expected.should.be.true;
                    _done();
                });
            });
        });
        it('should function correctly with nested calls', function(_done) {
            var dummy = new Dummy(false, serverPort, '127.0.0.1', '\n', function() {
                dummy.send('hey', 'you sent : hey', function(_expected, _data) {
                    _expected.should.be.true;
                    dummy.send('yo', 'you sent : yo', function(_expected, _data) {
                        _expected.should.be.true;
                        _done();
                    });
                });
            });
        });
    });
    describe('#sendObj()', function() {
        //the following two tests are mostly self explanatory
        it('should send objects and recieve them', function(_done) {
            var dummy = new Dummy(false, serverPort, '127.0.0.1', '\n', function() {
                dummy.sendObj({greeting: 'hello'}, {object: {greeting: 'hello'}}, function(_expected, _data) {
                    _expected.should.be.true;
                    _done();
                });
            });
        });
    });
    describe('#wait()', function() {
        var responseServer;
        before(function(_done) {
            responseServer = net.createServer(function(_socket) {
                setTimeout(function() {
                    _socket.write('you connected\n')
                    _socket.end();
                }, 5);
            });
            responseServer.listen(serverPort + 1, function(){
                _done();
            });
        });
        after(function(_done) {
            responseServer.close();
            _done();
        });
        it('should wait for a specific response (without sending) and call a callback', function(_done) {
            var dummy = new Dummy(false, serverPort + 1, '127.0.0.1', '\n', function() {
                dummy.wait('you connected', function(expected, data) {
                    expected.should.be.true;
                    _done();
                });
            });
        });
    });
    describe('#waitObj()', function() {
        var responseServer;
        before(function(_done) {
            responseServer = net.createServer(function(_socket) {
                setTimeout(function() {
                    _socket.write('{"data":"a response"}\n')
                    _socket.end();
                }, 5);
            });
            responseServer.listen(serverPort + 1, function(){
                _done();
            });
        });
        after(function(_done) {
            responseServer.close();
            _done();
        });
        it('should wait for a specific response (without sending) and call a callback', function(_done) {
            var dummy = new Dummy(false, serverPort + 1, '127.0.0.1', '\n', function() {
                dummy.waitObj({data: 'a response'}, function(expected, data) {
                    expected.should.be.true;
                    _done();
                });
            });
        });
    });
});